{"version":3,"sources":["db.js","settings.js","profile.js","sidebar.js","message.js","contact.js","roster.js","messages.js","inbox.ts","App.js","index.js"],"names":["db","Dexie","version","stores","messages","Settings","client","me","onClose","open","useState","mfa","setMfa","qr","setQr","loading","setLoading","token","setToken","useEffect","a","Auth","currentAuthenticatedUser","user","getPreferredMFA","mfaType","setupTOTP","email","attributes","code","str","onMfaChange","setPreferredMFA","checkToken","verifyTotpToken","then","alert","catch","e","console","log","Dialog","fullWidth","maxWidth","DialogTitle","DialogContent","FormControlLabel","control","Checkbox","onChange","checked","label","value","size","TextField","sx","my","target","InputProps","endAdornment","Button","disabled","onClick","DialogActions","initials","u","name","split","slice","map","n","substr","Profile","signOut","setStatus","anchorEl","setAnchorEl","activity","setActivity","showSettings","setShowSettings","Boolean","handleClose","statusList","key","color","icon","Circle","ListItem","disablePadding","event","currentTarget","mx","Avatar","ListItemText","primary","primaryTypographyProps","textOverflow","overflow","whiteSpace","secondary","user_email","secondaryTypographyProps","title","config","jid","Menu","id","s","MenuItem","status","sendPresence","ListItemIcon","fontSize","text","prompt","publishActivity","Divider","items","route","iconComponent","ContactsIcon","ChatIcon","SideBar","setNav","nav","hostname","List","display","flexDirection","width","minWidth","background","i","IconComponent","ListItemButton","mt","justifyContent","Chat","message","mine","isRoom","from","includes","Box","className","blue","p","borderRadius","marginLeft","marginRight","wordBreak","style","timestamp","toLocaleString","componentDecorator","decoratedHref","decoratedText","href","isImage","body","rel","src","alt","maxHeight","isFile","textDecoration","Card","Stack","direction","mr","nameFromUrl","createMeeting","API_BASE","jwt","url","mstart","parseInt","Date","getTime","formData","FormData","append","toString","fetch","method","headers","Authorization","res","json","AddUserToRoomPrompt","close","allUsers","room","setUser","Autocomplete","_","options","user_id","renderInput","params","server","setRoomAffiliation","upload","files","Promise","all","Array","f","mediaType","type","getUploadService","service","getUploadSlot","slot","downloadUrl","download","uploadUrl","Message","members","setMembers","setMessage","uploading","setUploading","showAddUserToRoom","setShowAddUserToRoom","scrollRef","useRef","fileRef","roomListAnchorEl","setRoomListAnchorEl","showRoomList","attachFile","urls","forEach","sendMessage","to","useDropzone","onDrop","noClick","noKeyboard","getRootProps","isDragActive","getInputProps","useLiveQuery","where","equals","sortBy","or","and","m","group","extendedMessages","find","removeContact","leaveRoom","removeRosterItem","unsubscribe","invite","uuid","memberList","getRoomMembers","muc","users","closeRoomList","current","scrollTop","scrollHeight","allOtherUsers","filter","flexGrow","Backdrop","px","alignItems","IconButton","ml","MenuListProps","ref","placeholder","onKeyPress","CircularProgress","flexShrink","click","string","URL","protocol","isUrl","match","test","parts","length","Contact","available","away","unavailable","Popover","anchorOrigin","vertical","horizontal","Badge","componentsProps","badge","backgroundColor","border","height","overlap","badgeContent","invisible","variant","pl","Typography","fontWeight","AddRoomPrompt","add","roomName","setRoomName","AddContactPrompt","newContact","setNewContact","userDisplayName","user_firstname","user_lastname","Roster","roster","MUC_LIGHT_HOSTNAME","search","setSearch","subNav","setSubNav","showAddContact","setShowAddContact","showAddRoom","setShowAddRoom","tab","setTab","menuAnchorEl","setMenuAnchorEl","showAddMenu","profileAnchorEl","setProfileAnchorEl","focusedUser","setFocusedUser","closeAddMenu","addRoom","crypto","randomUUID","joinRoom","configureRoom","fields","filteredRoster","r","toLowerCase","subscribe","Paper","borderBottom","borderColor","Tabs","idx","Tab","index","ListItemAvatar","stopPropagation","AddChatPrompt","Messages","showAddChat","setShowAddChat","tos","orderBy","uniqueKeys","froms","groups","jids","concat","v","indexOf","filteredUsers","stanzas","define","element","unread","JXT","attribute","queryid","namespace","path","result","getInbox","sendIQ","inbox","on","msg","emit","window","resource","localStorage","getItem","setItem","initXMPP","password","XMPP","transports","websocket","IncomingInvites","accept","reject","invites","responses","getAllUsers","apiBase","ok","userFullName","user_displayname","App","signOutAWS","setClient","setJwt","setRoster","presence","setPresence","activities","setActivities","incomingInvites","setIncomingInvites","inviteResponses","setInviteResponses","setAllUsers","connected","setConnected","serviceName","domain","xmppHostname","mucHostname","signIn","username","clear","session","signInUserSession","idToken","jwtToken","xmpp","use","IqInbox","cognitoUsers","extendedUsers","updateCaps","legacyCapabilities","disco","getCaps","enableKeepAlive","enableCarbons","getRoster","searchHistory","paging","before","with","prev","after","put","mam","archive","item","delay","forwarded","stamp","data","acceptSubscription","setTimeout","connect","addEventListener","disconnect","error","extendedRoster","statuses","Object","values","some","every","reconnect","useCallback","currentSession","updateConfig","credentials","removeItem","Snackbar","cursor","Alert","severity","Context","createContext","HOSTNAME_KEY","AppContainer","setConfig","configure","getServiceConfig","Amplify","region","userPoolId","userPoolWebClientId","Provider","Authenticator","components","Header","textAlign","marginBottom","signUpAttributes","loginMechanisms","mode","location","reload","ReactDOM","render","StrictMode","CssBaseline","document","getElementById"],"mappings":"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","file":"static/js/main.2ae9bc53.chunk.js","sourcesContent":["import Dexie from 'dexie';\n\nconst db = new Dexie('visionable-xmpp-test-app');\n\ndb.version(1).stores({\n  messages: '++id, group, from, to, body, type, timestamp',\n});\n\nexport default db;\n","import { useState, useEffect } from 'react';\nimport {\n  Dialog,\n  DialogTitle,\n  DialogContent,\n  DialogContentText,\n  DialogActions,\n  FormControlLabel,\n  Button,\n  Checkbox,\n  TextField,\n} from '@mui/material';\n\nimport { QRCodeSVG } from 'qrcode.react'\n\nimport { Auth } from \"aws-amplify\";\n\nconst Settings = ({ client, me, onClose, open }) => {\n  const [mfa, setMfa] = useState(false);\n  const [qr, setQr] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const [token, setToken] = useState(\"\");\n\n  useEffect(async () => {\n    const user = await Auth.currentAuthenticatedUser();\n    const mfaType = await Auth.getPreferredMFA(user);\n    setMfa(mfaType === 'SOFTWARE_TOKEN_MFA')\n    setLoading(false);\n  }, []);\n\n  const setupTOTP = async () => {\n    const user = await Auth.currentAuthenticatedUser();\n    const { attributes: { email } } = user;\n\n    const code = await Auth.setupTOTP(user);\n    const issuer = \"Visionable\"; // TODO: ?\n    const str = `otpauth://totp/Visionable:${email}?secret=${code}&issuer=${issuer}`;\n    setQr(str);\n  }\n\n  const onMfaChange = async () => {\n    const user = await Auth.currentAuthenticatedUser();\n    setMfa(!mfa);\n\n    if (!mfa) {\n      setupTOTP();\n    } else {\n      Auth.setPreferredMFA(user, 'NOMFA');\n    }\n  }\n\n  const onTokenChange = (e) => {\n    setToken(e.target.value);\n  };\n\n  const checkToken = async () => {\n    const user = await Auth.currentAuthenticatedUser();\n\n    Auth.verifyTotpToken(user, token)\n      .then(() => {\n        Auth.setPreferredMFA(user, 'TOTP');\n        alert(\"Successfully enabled MFA\")\n        setQr(null);\n      })\n      .catch((e) => {\n        console.log(\"ERROR\", e);\n        alert(\"Error enabling MFA\");\n      });\n  };\n\n  return (\n    <Dialog open={open} onClose={onClose} fullWidth maxWidth=\"sm\">\n      <DialogTitle>Settings</DialogTitle>\n\n      <DialogContent>\n        {loading\n          ? <div>Loading</div>\n          : <>\n            <FormControlLabel control={<Checkbox onChange={onMfaChange} checked={mfa} />} label=\"Enable MFA\" />\n\n            {mfa && qr && <>\n              <br />\n              <QRCodeSVG value={qr} size={200} />\n              <br />\n              <TextField\n                sx={{ my: 1 }}\n                onChange={onTokenChange}\n                label=\"Verification Code\"\n                InputProps={{endAdornment: <Button disabled={!token} onClick={checkToken}>Verify</Button>}}\n                />\n              </>}\n          </>}\n      </DialogContent>\n\n      <DialogActions>\n        <Button onClick={onClose}>Close</Button>\n      </DialogActions>\n    </Dialog>\n  );\n};\n\nexport default Settings\n","import { useState } from 'react';\nimport Avatar from '@mui/material/Avatar';\nimport ListItemAvatar from '@mui/material/Avatar';\nimport Menu from '@mui/material/Menu';\nimport MenuItem from '@mui/material/MenuItem';\nimport Divider from '@mui/material/Divider';\nimport ListItem from '@mui/material/ListItem';\nimport ListItemIcon from '@mui/material/ListItemIcon';\nimport ListItemButton from '@mui/material/ListItemIcon';\nimport ListItemText from '@mui/material/ListItemText';\n\nimport Settings from '@mui/icons-material/Settings';\nimport Logout from '@mui/icons-material/Logout';\nimport Circle from '@mui/icons-material/Circle';\n\nimport SettingsDialog from './settings';\n\nconst Profile = ({ client, me, signOut }) => {\n  const [, setStatus] = useState(\"available\");\n  const [anchorEl, setAnchorEl] = useState(null);\n  // const [newActivity, setNewActivity] = useState(\"\");\n  const [activity, setActivity] = useState(\"\"); // TODO: get last activity\n  const [showSettings, setShowSettings] = useState(false);\n\n  const open = Boolean(anchorEl);\n\n  const handleClick = (event) => {\n    setAnchorEl(event.currentTarget);\n  };\n\n  const handleClose = () => {\n    setAnchorEl(null);\n  };\n\n  const changeStatus = (status) => {\n    setStatus(status);\n    client.sendPresence({ status });\n  };\n\n  const activityPrompt = () => { // TODO: use mui\n    const text = prompt(\"Enter a custom message\");\n    // setNewActivity(text);\n    // sendActivity();\n    client.publishActivity({ text })\n    setActivity(text);\n  }\n\n  /*\n  const sendActivity = () => {\n    client.publishActivity({ text: activity })\n    setActivity(newActivity);\n  }\n*/\n\n  const statusList = [\n    {\n      key: \"available\",\n      color: \"#53b397\",\n      label: \"Available\",\n      icon: Circle,\n    },\n    {\n      key: \"in-meeting\",\n      color: \"#ea3323\",\n      label: \"In a meeting\",\n      icon: Circle,\n    },\n    {\n      key: \"away\",\n      color: \"#f0a73e\",\n      label: \"Away\",\n      icon: Circle,\n    },\n  ]\n\n  return (\n    <>\n      <ListItem disablePadding>\n        <ListItemButton onClick={handleClick} sx={{ mx: 1 }}>\n          <ListItemAvatar>\n            <Avatar>{initials(me)}</Avatar>\n          </ListItemAvatar>\n        </ListItemButton>\n\n        <ListItemText\n          primary={me.name}\n          primaryTypographyProps={{ color: \"white\", textOverflow: \"ellipsis\", overflow: \"hidden\", whiteSpace: \"nowrap\" }}\n          secondary={me.user_email}\n          secondaryTypographyProps={{ color: \"white\", textOverflow: \"ellipsis\", overflow: \"hidden\", whiteSpace: \"nowrap\" }}\n          title={client.config.jid}\n        />\n      </ListItem>\n\n      <Menu\n        anchorEl={anchorEl}\n        id=\"account-menu\"\n        open={open}\n        onClose={handleClose}\n        onClick={handleClose}\n      >\n        {statusList.map((s) => (\n          <MenuItem key={s.key} onClick={() => changeStatus(s.key)}>\n            <ListItemIcon>\n              <Circle fontSize=\"small\" sx={{ color: s.color }} />\n            </ListItemIcon>\n\n            <ListItemText primary={s.label} />\n          </MenuItem>\n        ))}\n\n        <MenuItem onClick={activityPrompt}>\n          {activity || <i>Custom message</i>}\n        </MenuItem>\n\n        <Divider />\n\n        <MenuItem onClick={() => {setShowSettings(true)}}>\n          <ListItemIcon>\n            <Settings fontSize=\"small\" />\n          </ListItemIcon>\n          Settings\n        </MenuItem>\n\n        <MenuItem onClick={signOut}>\n          <ListItemIcon>\n            <Logout fontSize=\"small\" />\n          </ListItemIcon>\n          Logout\n        </MenuItem>\n      </Menu>\n\n      <SettingsDialog open={showSettings} onClose={() => setShowSettings(false)} client={client} me={me} />\n    </>\n  );\n};\n\n// TODO put this is allUsers state\nfunction initials(u) {\n  return u.name?.split(\" \")?.slice(0, 2)?.map(n => n.substr(0, 1));\n}\n\nexport default Profile;\n","import {\n  List,\n  ListItem,\n  ListItemButton,\n  ListItemIcon,\n  ListItemText,\n} from \"@mui/material\";\n\nimport {\n  Contacts as ContactsIcon,\n  Chat as ChatIcon,\n} from \"@mui/icons-material\";\n\nimport Profile from './profile';\n\nconst items = [\n  {\n    route: \"contacts\",\n    label: \"Contacts\",\n    iconComponent: ContactsIcon,\n  },\n  {\n    route: \"messages\",\n    label: \"Messages\",\n    iconComponent: ChatIcon,\n  },\n]\n\nconst SideBar = ({ client, me, setNav, nav, signOut, hostname }) => (\n  <List sx={{\n    display: \"flex\",\n    flexDirection: \"column\",\n    width: \"240px\",\n    minWidth: \"240px\",\n    background: \"#091c38\",\n    color: \"white\"\n  }}>\n    <Profile client={client} me={me} signOut={signOut} />\n\n    {items.map(i => {\n      const IconComponent = i.iconComponent;\n\n      return (\n        <ListItem key={i.route} disablePadding sx={{ background: nav === i.route ? 'rgba(255,255,255,0.1)' : 'transparent' }}>\n          <ListItemButton onClick={() => setNav(i.route)}>\n            <ListItemIcon>\n              <IconComponent sx={{ color: \"white\" }} />\n            </ListItemIcon>\n\n            <ListItemText>\n              {i.label}\n            </ListItemText>\n          </ListItemButton>\n        </ListItem>\n      )})}\n\n    {/* <ListItem disablePadding sx={{ mt: \"auto\" }}> */}\n    {/*   <ListItemButton onClick={signOut}> */}\n    {/*     <ListItemIcon> */}\n    {/*       <LogoutIcon sx={{ color: \"white\" }} /> */}\n    {/*     </ListItemIcon> */}\n\n    {/*     <ListItemText> */}\n    {/*       Log Out */}\n    {/*     </ListItemText> */}\n    {/*   </ListItemButton> */}\n    {/* </ListItem> */}\n\n    <ListItem sx={{ mt: \"auto\", justifyContent: \"center\", color: \"#bbb\" }}>\n      {hostname}\n    </ListItem>\n  </List>\n);\n\nexport default SideBar;\n","import {\n  Box,\n  Button,\n  Card,\n  Stack,\n  TextField,\n  IconButton,\n  Autocomplete,\n  Menu,\n  MenuItem,\n  Divider,\n  Backdrop,\n} from \"@mui/material\";\nimport { useState, useEffect, useRef } from \"react\";\nimport { useDropzone } from 'react-dropzone'\n\nimport Dialog from '@mui/material/Dialog';\nimport DialogActions from '@mui/material/DialogActions';\nimport DialogContent from '@mui/material/DialogContent';\nimport DialogTitle from '@mui/material/DialogTitle';\nimport CircularProgress from '@mui/material/CircularProgress';\nimport GroupAddIcon from '@mui/icons-material/GroupAdd';\nimport DeleteIcon from \"@mui/icons-material/Delete\";\nimport VideoCameraFrontIcon from '@mui/icons-material/VideoCameraFront';\nimport AttachFileIcon from '@mui/icons-material/AttachFile';\nimport FileDownloadIcon from '@mui/icons-material/FileDownload';\nimport { blue } from \"@mui/material/colors\";\n\nimport Linkify from 'react-linkify';\n// import { ReactTinyLink } from 'react-tiny-link'\nimport { useLiveQuery } from \"dexie-react-hooks\";\nimport db from './db';\n\nconst Message = ({ client, user, API_BASE, jwt, allUsers }) => {\n  const [members, setMembers] = useState([]);\n  const [message, setMessage] = useState(\"\");\n  const [uploading, setUploading] = useState(false);\n  const [showAddUserToRoom, setShowAddUserToRoom] = useState(false);\n  const scrollRef = useRef(null);\n  const fileRef = useRef(null);\n\n  const [roomListAnchorEl, setRoomListAnchorEl] = useState(null);\n  const showRoomList = Boolean(roomListAnchorEl);\n\n  const attachFile = async (files) => {\n    setUploading(true);\n    // upload all the files and get their URLs\n    const urls = await upload(files, client);\n    console.log('urls', urls);\n\n    // send out the notifications\n    urls.forEach((url) => {\n      if (url) {\n        const type = user.isRoom ? 'groupchat' : 'chat';\n        client.sendMessage({ to: user.jid, body: url, type });\n      } else {\n        console.log(\"upload failed\");\n      }\n    });\n    setUploading(false);\n  };\n\n  const onDrop = (files) => {\n    console.log(\"dropped files\", files);\n    attachFile(files);\n  };\n\n  const { getRootProps, getInputProps, isDragActive } = useDropzone({ onDrop, noClick: true, noKeyboard: true });\n\n  const messages = useLiveQuery(() => \n    user.isRoom\n      ? db.messages.where(\"group\").equals(user.jid).sortBy(\"timestamp\")\n      : db.messages.where(\"from\").equals(user.jid).or(\"to\").equals(user.jid).and((m) => !m.group).sortBy(\"timestamp\"),\n    [user], []);\n\n  const extendedMessages = messages\n    .map((message) => { // add user info\n      const user = allUsers.find((u) => message.from?.includes(u.user_id));\n      const name = user?.name || message.from;\n\n      return { ...message, user, name };\n    });\n\n  const removeContact = async () => {\n    if (user.isRoom) {\n      await client.setRoomAffiliation(user.jid, client.config.jid, \"none\");\n      await client.leaveRoom(user.jid);\n    } else {\n      await client.removeRosterItem(user.jid);\n      await client.unsubscribe(user.jid);\n    }\n  };\n\n  const sendMessage = () => {\n    if (!message) {\n      return;\n    }\n\n    const type = user.isRoom ? 'groupchat' : 'chat';\n    client.sendMessage({ to: user.jid, body: message, type });\n    setMessage(\"\");\n  };\n\n  const invite = async () => {\n    const body = await createMeeting(API_BASE, jwt);\n    if (body.uuid) {\n      client.sendMessage({ to: user.jid, body: body.uuid, type: 'meeting-invite' });\n    }\n  };\n\n  const memberList = async (event) => {\n    const res = await client.getRoomMembers(user.jid);\n\n    setMembers(res.muc.users.map((m) => ({\n      ...m,\n      name: allUsers.find((u) => m.jid.includes(u.user_id))?.name,\n    })));\n\n    setRoomListAnchorEl(event.target);\n  };\n\n  const closeRoomList = () => setRoomListAnchorEl(null);\n  const openAddUser = () => {\n    closeRoomList();\n    setShowAddUserToRoom(true);\n  }\n\n  useEffect(() => {\n    scrollRef.current.scrollTop = scrollRef?.current?.scrollHeight;\n  }, [messages]);\n\n  const allOtherUsers = allUsers.filter((u) => !client.config.jid.includes(u.user_id));\n\n  return (\n    <Stack sx={{ flexGrow: 1 }} {...getRootProps()}>\n      <AddUserToRoomPrompt\n        client={client}\n        room={user}\n        open={showAddUserToRoom}\n        close={() => setShowAddUserToRoom(false) }\n        allUsers={allOtherUsers}\n      />\n\n      <Backdrop open={isDragActive} sx={{ color: \"white\" }}><h3>Drop files to upload</h3></Backdrop>\n\n      <Stack direction=\"row\" sx={{ px: 2, background: \"white\", alignItems: \"center\" }}>\n        <h2>{user.name}</h2>\n\n        <IconButton sx={{ ml: \"auto\" }} onClick={removeContact} title={user.isRoom ? \"Leave Group\" : \"Remove Contact\"}>\n          <DeleteIcon fontSize=\"inherit\" />\n        </IconButton>\n\n        {user.isRoom && <>\n          <IconButton onClick={memberList}>\n            <GroupAddIcon fontSize=\"inherit\" />\n          </IconButton>\n\n          <Menu\n            id=\"basic-menu\"\n            anchorEl={roomListAnchorEl}\n            open={showRoomList}\n            onClose={closeRoomList}\n            MenuListProps={{\n              'aria-labelledby': 'basic-button',\n            }}\n          >\n            {members.map((m) => (\n              <MenuItem key={m.jid}>{m.name}</MenuItem>\n            ))}\n            <Divider />\n            <MenuItem onClick={openAddUser}>Add</MenuItem>\n          </Menu>\n        </>}\n\n        <IconButton onClick={invite}>\n          <VideoCameraFrontIcon fontSize=\"inherit\" />\n        </IconButton>\n      </Stack>\n\n      <Stack sx={{ background: \"#eee\", flexGrow: 1, overflow: \"auto\", px: \"10%\" }} ref={scrollRef}>\n        {extendedMessages.map(m => <Chat key={m.id} message={m} client={client} isRoom={user.isRoom} />)}\n      </Stack>\n\n      <Stack direction=\"row\" sx={{ p: 1 }}>\n        <TextField\n          onChange={(e) => setMessage(e.target.value)}\n          value={message}\n          sx={{ flexGrow: 1 }}\n          placeholder=\"Send a message...\"\n          onKeyPress={(e) => e.key === 'Enter' && sendMessage() }\n          InputProps={{ endAdornment: <>\n            {uploading\n              ? <CircularProgress />\n              : <IconButton style={{ flexShrink: \"0\" }} onClick={() => fileRef.current.click()}>\n                <AttachFileIcon fontSize=\"inherit\" />\n                <input\n                  disabled={uploading}\n                  type=\"file\"\n                  style={{ display: \"none\" }}\n                  ref={fileRef}\n                  onChange={(e) => attachFile(e.target.files)}\n                  />\n              </IconButton>}\n            <Button onClick={sendMessage}>Send</Button>\n          </>}}\n        />\n      </Stack>\n    </Stack>\n  );\n};\n\nconst Chat = ({ message, client, isRoom }) => {\n  const mine = !message.from || message.from.includes(client.config.jid);\n\n  // if we're in a room, grab the user's jid from the `from` field\n  // if it's a direct chat, grab just the bare JID\n  // const jid = message.from?.split(\"/\")[isRoom ? 1 : 0];\n\n  return (\n    <Box\n      className={`chat-message ${mine ? \"mine\" : \"\"}`}\n      sx={{\n        background: mine ? blue[700] : \"white\",\n        color: mine ? \"white\" : \"black\",\n        p: 1.5,\n        mx: 2, my: 1,\n        borderRadius: 2,\n        marginLeft: mine ? \"auto\" : 0,\n        marginRight: mine ? 0 : \"auto\",\n        wordBreak: \"break-all\",\n      }}\n    >\n      <span style={{ fontSize: \"0.8em\" }}>\n        <b>{message.name}</b>\n          <span style={{ marginLeft: \"1em\", color: mine ? \"#eee\" : \"#666\" }}>{message.timestamp?.toLocaleString()}</span>\n      </span>\n      <br />\n      <Linkify componentDecorator={(decoratedHref, decoratedText, key) => (\n        <a target=\"blank\" href={decoratedHref} key={key} style={{ color: \"inherit\" }}>\n          {decoratedText}\n        </a>\n      )}>\n        {isImage(message.body) && <div>\n          <a href={message.body} target=\"_blank\" rel=\"noreferrer\">\n            <img src={message.body} alt=\"\" style={{ maxHeight: \"50vh\", maxWidth: \"70%\" }} />\n          </a>\n        </div>}\n\n        {isFile(message.body) && !isImage(message.body) && (\n          <a href={message.body} target=\"_blank\" rel=\"noreferrer\" style={{ textDecoration: \"none\" }}>\n            <Card sx={{ background: \"#eee\", p: 1, mt: 1 }}>\n              <Stack direction=\"row\">\n                <FileDownloadIcon sx={{ mr: 1 }} />{nameFromUrl(message.body)}\n              </Stack>\n            </Card>\n          </a>\n        )}\n\n        {!isImage(message.body) && !isFile(message.body) && message.body}\n      </Linkify>\n    </Box>\n  );\n}\n\nasync function createMeeting(API_BASE, jwt) {\n  const url = `${API_BASE}/api/meeting`;\n  const mstart = parseInt(new Date().getTime() / 1000);\n\n  const formData = new FormData();\n  formData.append(\"name\", \"Instant Meeting\");\n  formData.append(\"mstart\", mstart.toString());\n  formData.append(\"duration\", \"3600\");\n\n  return fetch(url, {\n    method: \"POST\",\n    headers: {\n      Authorization: jwt,\n    },\n    body: formData,\n  }).then(res => res.json());\n};\n\nconst AddUserToRoomPrompt = ({ open, close, allUsers, client, room }) => {\n  const [user, setUser] = useState(\"\");\n\n  const onAdd = () => {\n    const jid = `${user}@${client.config.server}`;\n    client.setRoomAffiliation(room.jid, jid, \"member\")\n    close();\n  }\n\n  return (\n    <Dialog open={open} onClose={close}>\n      <DialogTitle>Add User to Room</DialogTitle>\n\n      <DialogContent>\n        <Autocomplete\n          sx={{ width: 400, my: 1 }}\n          onChange={(_, u) => u && setUser(u.id)}\n          options={allUsers.map(u => ({\n            label: `${u.name} (${u.user_email})`,\n            id: u.user_id,\n          }))}\n          renderInput={(params) => <TextField {...params} label=\"User\" />}\n        />\n      </DialogContent>\n\n      <DialogActions>\n        <Button onClick={close}>Cancel</Button>\n        <Button onClick={onAdd}>Add</Button>\n      </DialogActions>\n    </Dialog>\n  );\n}\n\nconst upload = async (files, client) => {\n  return await Promise.all(Array.from(files).map(async (f) => {\n    const { name, size, type: mediaType } = f; // TODO files with spaces in name fail\n    console.log(\"here\", name, size, mediaType);\n    const service = await client.getUploadService();\n    const slot = await client.getUploadSlot(service.jid, { name, size, mediaType })\n    const { download: downloadUrl, upload: { url: uploadUrl } } = slot;\n    console.log(\"uploadUrl\", uploadUrl);\n    try {\n      await fetch(uploadUrl, {\n        method: \"PUT\",\n        body: f,\n        headers: { \"x-amz-acl\": \"public-read\" },\n      });\n      return downloadUrl;\n    } catch(e) {\n      return null;\n    }\n  }));\n};\n\nexport default Message;\n\nfunction isUrl(string) {\n  let url;\n  \n  try {\n    url = new URL(string);\n  } catch (_) {\n    return false;  \n  }\n\n  return url.protocol === \"http:\" || url.protocol === \"https:\";\n}\n\nfunction isFile(string) {\n  return isUrl(string) && string.match(/amazonaws.*fileshare/);\n}\n\nfunction isImage(url) {\n  return /\\.(jpg|jpeg|png|webp|avif|gif|svg)$/.test(url);\n}\n\nfunction nameFromUrl(url) {\n  const parts = url.split(\"/\");\n  return parts[parts.length - 1];\n}\n\n","// import { useState } from \"react\";\n\nimport {\n  Popover,\n  Badge,\n  Box,\n  Stack,\n  Avatar,\n  Typography,\n} from \"@mui/material\";\nimport GroupsIcon from '@mui/icons-material/Groups';\n\nconst Contact = ({ anchorEl, user, onClose }) => {\n  console.log(\"rendering Contact card\", user);\n\n  const open = Boolean(anchorEl);\n\n  const status = user.isRoom ? '' : user.status;\n  const color = {\n    available: \"#51b397\",\n    away: \"#f0a73e\",\n    unavailable: \"gray\",\n    \"in-meeting\": \"#ea3323\",\n  }[status] || \"gray\";\n\n  return (\n    <Popover\n      open={open}\n      anchorEl={anchorEl}\n      onClose={onClose}\n      anchorOrigin={{\n        vertical: 'bottom',\n        horizontal: 'left',\n      }}\n    >\n      <Box sx={{ p: 2 }}>\n        <Stack direction=\"row\">\n          <Badge\n            componentsProps={{\n              badge: {\n                sx: {\n                  backgroundColor: color,\n                  border: \"2px solid white\",\n                  width: 14,\n                  height: 14,\n                  borderRadius: 7,\n                },\n              },\n            }}\n            overlap=\"circular\"\n            badgeContent=\" \"\n            invisible={true}\n            variant=\"dot\"\n            anchorOrigin={{\n              vertical: 'bottom',\n              horizontal: 'right',\n            }}\n          >\n            <Avatar sx={{ width: 56, height: 56 }}>\n              {user.isRoom\n                ? <GroupsIcon />\n                : initials(user)}\n            </Avatar>\n          </Badge>\n          \n          <Box sx={{ pl: 2 }}>\n            <Typography sx={{ fontWeight: 'bold', p: 0, m: 0 }}>{user.name}</Typography>\n            {!user.isRoom && <div>{user.status}</div>}\n            {!user.isRoom && <div>{user.user.user_email}</div>}\n          </Box>\n        </Stack>\n\n        <br />\n\n        <div>{user.activity}</div>\n      </Box>\n    </Popover>\n  );\n};\n\nexport default Contact;\n\n// TODO put this is allUsers state\nfunction initials(u) {\n  return u.name?.split(\" \")?.slice(0, 2)?.map(n => n.substr(0, 1));\n}\n\n","import { useState } from \"react\";\n\nimport {\n  Badge,\n  Box,\n  Button,\n  List,\n  ListItem,\n  ListItemAvatar,\n  ListItemButton,\n  Avatar,\n  ListItemText,\n  TextField,\n  Paper,\n  Stack,\n  Autocomplete,\n  IconButton,\n  Menu,\n  MenuItem,\n  Tabs,\n  Tab\n} from \"@mui/material\";\n\nimport Dialog from '@mui/material/Dialog';\nimport DialogActions from '@mui/material/DialogActions';\nimport DialogContent from '@mui/material/DialogContent';\nimport DialogTitle from '@mui/material/DialogTitle';\nimport AddIcon from '@mui/icons-material/Add';\nimport GroupsIcon from '@mui/icons-material/Groups';\n\nimport Message from './message';\nimport Contact from './contact';\n\nconst AddRoomPrompt = ({ open, close, add }) => {\n  const [roomName, setRoomName] = useState(\"\");\n\n  const onAdd = () => {\n    add(roomName);\n    close();\n  }\n\n  return (\n    <Dialog open={open} onClose={close}>\n      <DialogTitle>Add Group</DialogTitle>\n\n      <DialogContent>\n        <TextField\n          sx={{ width: 400, my: 1 }}\n          onChange={(e) => setRoomName(e.target.value)}\n          label=\"Group name\"\n        />\n      </DialogContent>\n\n      <DialogActions>\n        <Button onClick={close}>Cancel</Button>\n        <Button onClick={onAdd}>Add</Button>\n      </DialogActions>\n    </Dialog>\n  );\n};\n\nconst AddContactPrompt = ({ open, close, add, allUsers }) => {\n  const [newContact, setNewContact] = useState(\"\");\n\n  const onAdd = () => {\n    add(newContact);\n    close();\n  }\n\n  return (\n    <Dialog open={open} onClose={close}>\n      <DialogTitle>Add Contact</DialogTitle>\n\n      <DialogContent>\n        <Autocomplete\n          sx={{ width: 400, my: 1 }}\n          onChange={(_, u) => u && setNewContact(u.id)}\n          options={allUsers.map((u) => ({\n            label: userDisplayName(u),\n            id: u.user_id,\n          }))}\n          renderInput={(params) => <TextField {...params} label=\"User\" />}\n        />\n      </DialogContent>\n\n      <DialogActions>\n        <Button onClick={close}>Cancel</Button>\n        <Button onClick={onAdd}>Add</Button>\n      </DialogActions>\n    </Dialog>\n  );\n};\n\n// TODO use teh name property\nconst userDisplayName = (u) => `${u.user_firstname} ${u.user_lastname} (${u.user_email})`;\n\nconst Roster = ({\n  roster,\n  client,\n  allUsers,\n  API_BASE,\n  MUC_LIGHT_HOSTNAME,\n  jwt,\n}) => {\n  const [search, setSearch] = useState(\"\");\n  const [subNav, setSubNav] = useState(null);\n  const [showAddContact, setShowAddContact] = useState(false);\n  const [showAddRoom, setShowAddRoom] = useState(false);\n  const [tab, setTab] = useState(0);\n\n  const [menuAnchorEl, setMenuAnchorEl] = useState(null);\n  const showAddMenu = Boolean(menuAnchorEl);\n\n  const [profileAnchorEl, setProfileAnchorEl] = useState(null);\n  const [focusedUser, setFocusedUser] = useState(null);\n\n  const openAddMenu = (event) => {\n    setMenuAnchorEl(event.currentTarget);\n  };\n\n  const closeAddMenu = () => {\n    setMenuAnchorEl(null);\n  };\n\n  const openContact = (event, user) => {\n    console.log('here', user);\n    event.stopPropagation();\n    setFocusedUser(user);\n    setProfileAnchorEl(event.currentTarget);\n  }\n\n  const addContact = (uuid) => {\n    const jid = `${uuid}@${client.config.server}`;\n    client.subscribe(jid);\n  }\n\n  // TODO: this will use the Room API in the future\n  const addRoom = async (name) => {\n    const uuid = crypto.randomUUID();\n    const jid = `${uuid}@${MUC_LIGHT_HOSTNAME}`;\n    const res = await client.joinRoom(jid);\n    client.configureRoom(jid, { fields: [ { name: 'roomname', value: name } ] });\n  }\n\n  // filter by search\n  const filteredRoster = roster.filter(r =>\n    r.name?.toLowerCase().includes(search.toLowerCase()) || r.jid?.includes(search))\n  .filter(r => (tab === 0 && !r.isRoom) || (tab === 1 && r.isRoom));\n\n  const allOtherUsers = allUsers.filter((u) => !client.config.jid.includes(u.user_id));\n\n  return (\n    <>\n      <AddContactPrompt\n        add={addContact}\n        close={() => setShowAddContact(false)}\n        open={showAddContact}\n        allUsers={allOtherUsers}\n      />\n\n      <AddRoomPrompt\n        add={addRoom}\n        close={() => setShowAddRoom(false)}\n        open={showAddRoom}\n      />\n\n      {profileAnchorEl && focusedUser &&\n        <Contact user={focusedUser} anchorEl={profileAnchorEl} onClose={() => setProfileAnchorEl(null)}/>}\n\n      <Paper className=\"scroll-list-container\" sx={{ width: 300 }}>\n        <Box sx={{ px: 2 }}>\n          <Stack direction=\"row\" sx={{ alignItems: \"center\" }}>\n            <h2>Contacts</h2>\n\n            <IconButton sx={{ ml: \"auto\" }} onClick={openAddMenu}>\n              <AddIcon fontSize=\"inherit\" />\n            </IconButton>\n\n            <Menu\n              id=\"basic-menu\"\n              anchorEl={menuAnchorEl}\n              open={showAddMenu}\n              onClose={closeAddMenu}\n              MenuListProps={{\n                'aria-labelledby': 'basic-button',\n              }}\n            >\n              <MenuItem onClick={() => { closeAddMenu(); setShowAddContact(true)}}>Add Contact</MenuItem>\n              <MenuItem onClick={() => { closeAddMenu(); setShowAddRoom(true)}}>Add Group</MenuItem>\n            </Menu>\n          </Stack>\n\n          <TextField\n            type=\"search\"\n            label=\"Search\"\n            variant=\"filled\"\n            size=\"small\"\n            fullWidth\n            onChange={(e) => setSearch(e.target.value)}\n          />\n        </Box>\n\n        <Box sx={{ borderBottom: 1, borderColor: 'divider' }}>\n          <Tabs value={tab} onChange={(_, idx) => setTab(idx)} aria-label=\"basic tabs example\">\n            <Tab label=\"Contacts\" index={0} />\n            <Tab label=\"Groups\" index={1} />\n          </Tabs>\n        </Box>\n\n        <List className=\"scroll-list\">\n          {filteredRoster.map((u) => {\n            const status = u.isRoom ? '' : u.status;\n            const color = {\n              available: \"#51b397\",\n              away: \"#f0a73e\",\n              unavailable: \"gray\",\n              \"in-meeting\": \"#ea3323\",\n            }[status] || \"gray\";\n\n            return (\n              <ListItem key={u.jid} disablePadding>\n                <ListItemButton onClick={(e) => setSubNav(u)}>\n                  <ListItemAvatar>\n                    <Badge\n                      componentsProps={{\n                        badge: {\n                          sx: {\n                            backgroundColor: color,\n                            border: \"2px solid white\",\n                            width: 14,\n                            height: 14,\n                            borderRadius: 7,\n                          },\n                        },\n                      }}\n                      overlap=\"circular\"\n                      badgeContent=\" \"\n                      invisible={u.isRoom}\n                      variant=\"dot\"\n                      anchorOrigin={{\n                        vertical: 'bottom',\n                        horizontal: 'right',\n                      }}\n                    >\n                      <Avatar onClick={(e) => openContact(e, u)}>\n                        {u.isRoom\n                          ? <GroupsIcon />\n                          : initials(u)}\n                      </Avatar>\n                    </Badge>\n                  </ListItemAvatar>\n\n                  <ListItemText\n                    primary={<>{u.name} {!u.isRoom ? <span style={{ color: \"#888\" }}>- {u.user?.user_email}</span> : ''}</>}\n                    primaryTypographyProps={{ textOverflow: \"ellipsis\", overflow: \"hidden\", whiteSpace: \"nowrap\" }}\n                    secondary={u.activity ? u.activity : \"\"}\n                    secondaryTypographyProps={{ textOverflow: \"ellipsis\", overflow: \"hidden\", whiteSpace: \"nowrap\" }}\n                    />\n                </ListItemButton>\n              </ListItem>\n            )})}\n        </List>\n      </Paper>\n\n      <Paper className=\"right-section\">\n        {subNav && <Message allUsers={allUsers} client={client} user={subNav} API_BASE={API_BASE} jwt={jwt} />}\n      </Paper>\n    </>\n  );\n};\n\n// TODO put this is allUsers state\nfunction initials(u) {\n  return u.name?.split(\" \")?.slice(0, 2)?.map(n => n.substr(0, 1));\n}\n\nexport default Roster;\n","import { useState } from 'react';\nimport {\n  Box,\n  Button,\n  TextField,\n  Paper,\n  Stack,\n  IconButton,\n  Dialog,\n  DialogTitle,\n  DialogContent,\n  DialogActions,\n  List,\n  ListItem,\n  ListItemButton,\n  ListItemAvatar,\n  ListItemText,\n  Avatar,\n  Autocomplete,\n} from \"@mui/material\";\nimport { useLiveQuery } from \"dexie-react-hooks\";\n\nimport AddIcon from '@mui/icons-material/Add';\nimport GroupsIcon from '@mui/icons-material/Groups';\n\nimport Message from \"./message\";\n\nimport db from \"./db\";\n\nconst AddChatPrompt = ({ open, close, add, allUsers }) => {\n  const [newContact, setNewContact] = useState(\"\");\n\n  const onAdd = () => {\n    add(newContact);\n    close();\n  }\n\n  return (\n    <Dialog open={open} onClose={close}>\n      <DialogTitle>Find a User</DialogTitle>\n\n      <DialogContent>\n        <Autocomplete\n          sx={{ width: 400, my: 1 }}\n          onChange={(_, u) => u && setNewContact(u.id)}\n          options={allUsers.map(u => ({\n            label: userDisplayName(u),\n            id: u.user_id,\n          }))}\n          renderInput={(params) => <TextField {...params} label=\"User\" />}\n        />\n      </DialogContent>\n\n      <DialogActions>\n        <Button onClick={close}>Cancel</Button>\n        <Button onClick={onAdd}>Add</Button>\n      </DialogActions>\n    </Dialog>\n  );\n};\n\n// TODO use the name property\nconst userDisplayName = (u) => `${u.user_firstname} ${u.user_lastname} (${u.user_email})`;\n\nconst Messages = ({ client, allUsers, roster, jwt, API_BASE }) => {\n  const [search, setSearch] = useState(\"\");\n  const [subNav, setSubNav] = useState(null);\n  const [showAddChat, setShowAddChat] = useState(false);\n\n  // pull out all of the unique IDs from all of the messages\n  const tos = useLiveQuery(() => db.messages.orderBy(\"to\").uniqueKeys()) || [];\n  const froms = useLiveQuery(() => db.messages.orderBy(\"from\").uniqueKeys()) || [];\n  const groups = useLiveQuery(() => db.messages.orderBy(\"group\").uniqueKeys()) || [];\n  const jids = tos.concat(froms).concat(groups)\n  .filter((v, i, a) => a.indexOf(v) === i) // all unique jids\n  .filter((jid) => jid !== client.config.jid); // that aren't you\n\n  const users = jids?.map(jid => { // add names\n    const user = allUsers.find((u) => jid.includes(u.user_id));\n    const name = user?.name // user names come from all users\n      || roster.find((r) => r.jid === jid)?.name // room names will be in your roster\n      || jid;\n    const isRoom = groups.includes(jid);\n\n    return { jid, user, name, isRoom };\n  });\n\n  const filteredUsers = users?.filter((u) => { // filter by search\n    const s = search.toLowerCase();\n    return u.name?.toLowerCase().includes(s)\n      || s.includes(u.name?.toLowerCase())\n      || u.user?.user_email?.includes(s)\n      || s.includes(u.user?.user_email);\n  });\n\n  const addChat = (uuid) => {\n    console.log(\"addChat\", uuid);\n    const jid = `${uuid}@${client.config.server}`;\n    console.log(\"jid\", jid);\n    // TODO\n  };\n\n  return (\n    <>\n      <AddChatPrompt\n        add={addChat}\n        close={() => setShowAddChat(false)}\n        open={showAddChat}\n        allUsers={allUsers}\n      />\n\n      <Paper className=\"scroll-list-container\" sx={{ width: 300 }}>\n        <Box sx={{ px: 2 }}>\n          <Stack direction=\"row\" sx={{ alignItems: \"center\" }}>\n            <h2>Chat</h2>\n            {/* <IconButton sx={{ ml: \"auto\" }} onClick={() => setShowAddChat(true)}> */}\n            {/*   <AddIcon fontSize=\"inherit\" /> */}\n            {/* </IconButton> */}\n          </Stack>\n\n          <TextField\n            type=\"search\"\n            label=\"Search\"\n            variant=\"filled\"\n            size=\"small\"\n            fullWidth\n            onChange={(e) => setSearch(e.target.value)}\n            />\n        </Box>\n\n        <List className=\"scroll-list\">\n          {filteredUsers.map((u) => (\n            <ListItem key={u.jid} disablePadding>\n              <ListItemButton onClick={() => setSubNav(u)}>\n                <ListItemAvatar>\n                  <Avatar>\n                    {u.isRoom\n                      ? <GroupsIcon />\n                      : initials(u)}\n                  </Avatar>\n                </ListItemAvatar>\n\n                <ListItemText\n                  primary={u.name}\n                  primaryTypographyProps={{ textOverflow: \"ellipsis\", overflow: \"hidden\", whiteSpace: \"nowrap\" }}\n                  secondary={u.user?.user_email}\n                  secondaryTypographyProps={{ textOverflow: \"ellipsis\", overflow: \"hidden\", whiteSpace: \"nowrap\" }}\n                  title={u.jid}\n                />\n              </ListItemButton>\n            </ListItem>\n          ))}\n        </List>\n      </Paper>\n\n      <Paper className=\"right-section\">\n        {subNav && <Message allUsers={allUsers} client={client} user={subNav} API_BASE={API_BASE} jwt={jwt} />}\n      </Paper>\n    </>\n  );\n};\n\n// TODO put this is allUsers state\nfunction initials(u) {\n  return u.name?.split(\" \")?.slice(0, 2)?.map(n => n.substr(0, 1));\n}\n\nexport default Messages;\n","import { Agent, JXT } from 'stanza';\nimport { IQ, ReceivedMessage } from 'stanza/protocol';\n\n// 1. Declare our new custom stanza extension type\nexport interface InboxMessage extends ReceivedMessage {\n  result?: InboxResult;\n}\n\nexport interface InboxResult {\n  forwarded?: InboxMessage;\n}\n\nexport interface InboxMessage {\n  message?: string;\n}\n\n// 2. Begin injecting our plugin's type information into StanzaJS.\ndeclare module 'stanza' {\n\n    // 3. Declare a new method for the StanzaJS agent\n    export interface Agent {\n        getInbox(): Promise<IQ>\n    }\n\n    // 4. Declare our event types. (Event names are the fields in AgentEvents.)\n    export interface AgentEvents {\n      inbox: InboxMessage;\n    }\n\n    // 5. Stanza definitions MUST be placed in the Stanzas namespace\n    namespace Stanzas {\n\n        // 6. Attach our new definition to Message stanzas\n        export interface Message {\n            result?: InboxResult;\n        }\n    }\n}\n\n\n// 7. Create a plugin function\nexport default function (client: Agent, stanzas: JXT.Registry) {\n\n    // 8. Create and register our custom stanza definition\n    stanzas.define({\n        element: 'result',\n        fields: {\n            unread: JXT.attribute('unread'),\n            queryid: JXT.attribute('queryid'),\n        },\n        namespace: 'erlang-solutions.com:xmpp:inbox:0',\n        path: 'message.result'\n    });\n\n    stanzas.define({\n        element: 'forwarded',\n        fields: {\n            unread: JXT.attribute('unread')\n        },\n        namespace: 'urn:xmpp:forward:0',\n        path: 'message.result.forwarded'\n    });\n\n    stanzas.define({\n        element: 'inbox',\n        fields: {\n            result: JXT.text()\n        },\n        namespace: 'erlang-solutions.com:xmpp:inbox:0',\n        path: 'iq.inbox'\n    });\n\n    // 9. Add API to the StanzaJS agent for sending\n    client.getInbox = () => {\n        return client.sendIQ({\n            type: 'set',\n            inbox: \"test\",\n        });\n    };\n\n    // 10. Listen for incoming inbox data and emit our own event\n    client.on('message', msg => {\n        if (msg.result) {\n            client.emit('inbox', msg);\n        }\n    });\n};\n","import { useState, useEffect, useCallback } from \"react\";\nimport * as XMPP from \"stanza\";\n\nimport {\n  Box,\n  Button,\n  Dialog,\n  DialogTitle,\n  DialogContent,\n  DialogActions,\n  Snackbar,\n  Alert,\n} from \"@mui/material\";\n\nimport db from \"./db\";\nimport \"./App.css\";\nimport SideBar from \"./sidebar\";\nimport Roster from \"./roster\";\nimport Messages from \"./messages\";\nimport { Auth } from \"aws-amplify\";\n\nimport IqInbox from './inbox.ts';\n\nwindow.db = db;\n\nconst PROTOCOL = \"wss\";\nconst PORT = \"5443\";\nconst ENDPOINT = \"ws-xmpp\";\n\nconst resource = localStorage.getItem(\"xmpp-resource\") || crypto.randomUUID();\nlocalStorage.setItem(\"xmpp-resource\", resource);\n\nconst initXMPP = async (jid, password, hostname) =>\n  XMPP.createClient({\n    jid,\n    password,\n    resource,\n    transports: {\n      websocket: `${PROTOCOL}://${hostname}:${PORT}/${ENDPOINT}`,\n    },\n  });\n\nconst App = ({ signOutAWS, user, hostname }) => {\n  const [client, setClient] = useState(null);\n  const [jwt, setJwt] = useState(\"\");\n  const [roster, setRoster] = useState([]);\n  const [presence, setPresence] = useState({});\n  const [activities, setActivities] = useState({});\n  const [incomingInvites, setIncomingInvites] = useState([]);\n  const [inviteResponses, setInviteResponses] = useState({});\n  const [allUsers, setAllUsers] = useState([]);\n  const [nav, setNav] = useState(\"contacts\");\n  const [connected, setConnected] = useState(false);\n  const [server] = useState(hostname);\n\n  const [serviceName, ...[domain]] = server.split(/\\.(.*)/s); // split out the serviceName from the rest of the host\n  const xmppHostname = `${serviceName}-msg.${domain}`; // e.g. saas-msg.visionable.one\n  const mucHostname = `muclight.${xmppHostname}`; // e.g. muclight.saas-msg.visionable.one\n\n  const apiBase = `https://${serviceName}-api.${domain}`; // e.g. saas-api.visionable.one\n\n  const signIn = async () => {\n    if (client) {\n      return; // only sign in once\n    }\n\n    if (localStorage.getItem(\"username\") !== user.username) {\n      await db.messages.clear();\n    }\n    localStorage.setItem(\"username\", user.username);\n\n    try {\n      const { signInUserSession: session } = user;\n      const jwt = session.idToken.jwtToken;\n      setJwt(jwt);\n      const jid = `${user.username}@${xmppHostname}`;\n      const xmpp = await initXMPP(jid, jwt, xmppHostname);\n\n      xmpp.use(IqInbox);\n\n      setClient(xmpp);\n      setConnected(true);\n\n      const cognitoUsers = await getAllUsers(jwt, apiBase);\n      const extendedUsers = cognitoUsers.map((u) => ({ ...u, name: userFullName(u) }));\n      setAllUsers(extendedUsers);\n\n      window.client = xmpp;\n\n      xmpp.on(\"session:started\", async () => {\n        console.log(\"session:started\");\n        xmpp.updateCaps();\n        xmpp.sendPresence({\n          legacyCapabilities: xmpp.disco.getCaps() // have to enable this to get PEP notifications\n        });\n        xmpp.enableKeepAlive();\n        xmpp.enableCarbons();\n\n        const roster = (await xmpp.getRoster()).items;\n        setRoster(roster);\n\n        // get \"inbox\"\n        // const res = await xmpp.getInbox();\n        // console.log(\"INBOX RES\", res);\n\n        // Get all of the messages up until the last one I've seen\n        // const lastMessage = await db.messages.orderBy(\"timestamp\").last();\n        // getAllMessages({ client: xmpp, start: lastMessage?.timestamp });\n\n        // Get the last few messages for each of our roster items\n        roster.forEach((r) => {\n          if (r.groups.length) {\n            xmpp.searchHistory({ to: r.jid, paging: { before: \"\" }}); // 'to' for MUCs\n          } else {\n            xmpp.searchHistory({ with: r.jid, paging: { before: \"\" }});\n          }\n        });\n      });\n\n      xmpp.on(\"message\", (message) => {\n        if (message.type === 'meeting-invite') {\n          setIncomingInvites((prev) => [...prev, message]);\n        } else if (message.type === \"chat\" || message.type === \"groupchat\") {\n          const [before, after] = message.from.split(\"/\");\n          const group = message.type === \"chat\" ? null : before;\n          const from = message.type === \"chat\" ? before : after;\n\n          db.messages.put({\n            id: message.id,\n            from,\n            to: message.to,\n            body: message.body,\n            type: message.type,\n            group,\n            timestamp: new Date(),\n          }, message.id)\n        }\n      });\n\n      xmpp.on(\"message:sent\", (message) => {\n        if (message.type === 'meeting-invite') {\n          // TODO: display something in the chat\n        } else if (message.type === \"chat\") {\n          // TODO: until acked, put a pending status\n          db.messages.put({\n            id: message.id,\n            from: xmpp.config.jid,\n            to: message.to,\n            body: message.body,\n            type: message.type,\n            group: null,\n            timestamp: new Date(),\n          }, message.id)\n        }\n      });\n\n      xmpp.on(\"mam:item\", (mam) => {\n        const message = mam.archive?.item?.message;\n        const timestamp = mam.archive?.item?.delay?.timestamp;\n        if (message.type === \"chat\" || message.type === \"groupchat\") {\n          const [before, after] = message.from.split(\"/\");\n          const group = message.type === \"chat\" ? null : before;\n          const from = message.type === \"chat\" ? before : after;\n\n          db.messages.put({\n            id: message.id,\n            from,\n            to: message.to,\n            body: message.body,\n            type: message.type,\n            group,\n            timestamp: new Date(),\n          }, message.id)\n        }\n      });\n\n      xmpp.on(\"inbox\", (msg) => {\n        const timestamp = msg.result?.forwarded?.delay?.stamp;\n        const message = msg.result?.forwarded?.message;\n        console.log(\"inbox message\", message)\n\n        if (!message) { return; }\n        const { to } = message;\n\n        if (message.type === \"chat\") {\n          const [from] = message.from.split(\"/\");\n\n          db.messages.put({\n            id: message.id,\n            from,\n            to: message.to,\n            body: message.body,\n            type: message.type,\n            group: null,\n            timestamp,\n          }, message.id)\n        } else if (message.type === \"groupchat\") {\n\n        }\n      });\n\n      xmpp.on(\"subscribe\", (data) => { // if someone subscribes to us..\n        xmpp.acceptSubscription(data.from); // auto accept\n        xmpp.subscribe(data.from);\n      });\n\n      xmpp.on(\"unsubscribe\", () => { // if someone removes me from their roster\n        // xmpp.unsubscribe(data.from); // remove them from ours?\n      });\n\n      xmpp.on(\"roster:update\", async (data) => { // roster item change\n        data.roster.items.forEach((r) => {\n          xmpp.searchHistory({ with: r.jid, paging: { before: \"\" }}); // get the last few messages\n        });\n\n        setRoster((await xmpp.getRoster()).items)\n      });\n\n      // if someone adds you to a room, auto accept it\n      xmpp.on(\"muc:invite\", (data) => {\n        setTimeout(() => {\n          xmpp.joinRoom(data.room);\n        }, 1000);\n      });\n\n      // created or added to a room\n      xmpp.on(\"muc:available\", async () =>\n        setRoster((await xmpp.getRoster()).items)\n      );\n\n      // no longer in a room\n      xmpp.on(\"muc:unavailable\", async () =>\n        setRoster((await xmpp.getRoster()).items)\n      );\n\n      xmpp.on(\"presence\", (data) => {\n        setPresence((prev) => ({ ...prev, [data.from]: data }))\n      });\n\n      xmpp.on(\"activity\", (data) => {\n        const { jid, activity: { text } } = data;\n        console.log(\"ACTIVITY\", jid, text);\n        setActivities((prev) => ({ ...prev, [jid]: text }));\n      });\n\n      xmpp.on(\"*\", async (type, data) => {\n        console.log(type, data);\n      });\n\n      // on disconnect, retry\n      xmpp.on(\"disconnected\", () => {\n        console.log(\"DISCONNECTED\");\n        setConnected(false);\n        // setTimeout(xmpp.connect, 3000)\n      })\n\n      xmpp.on(\"connected\", () => {\n        setConnected(true);\n      })\n\n      xmpp.connect();\n\n      window.addEventListener('beforeunload', function(event) {\n        console.log('window.beforeunload');\n        xmpp.disconnect();\n      });\n    } catch (e) {\n      console.error(\"caught\", e);\n    }\n  };\n\n  useEffect(signIn, [user]);\n\n  // extend the roster with info from the User API, presence, etc.\n  const extendedRoster = roster.map(r => {\n    const user = allUsers.find(u => r.jid.includes(u.user_id));\n    const name = r.name // if the roster item has a name\n      ? r.name // use that\n      : user // otherwise, if there's a corresponding user from the User API\n        ? userFullName(user) // get the name of that\n        : r.jid;// otherwise, just show their JID\n\n    // grab all of the resources that we've been given presence for this user\n    const statuses = Object.values(presence)\n      .filter((u) => u.from.includes(r.jid))\n      .filter((u) => u.type !== 'unavailable')\n      .map((u) => u.status || 'available');\n\n    const status = statuses.length === 0 // if they have no resources online\n      ? 'unavailable' // they're unavailable\n      : statuses.some((s) => s === 'in-meeting') // if _any_ resource is in a meeting\n        ? 'in-meeting' // show in-meeting\n        : statuses.every((s) => s === 'away') // if _all_ of their resources are away\n          ? 'away' // show away\n          : statuses.every((s) => s === 'available') // if _all_ of their resources are available\n            ? 'available' // show available\n            : 'available'; // otherwise, if they have other online resources, show available\n\n    return {\n      ...r,\n      user,\n      name,\n      status,\n      statuses,\n      activity: activities[r.jid],\n      isRoom: !!r.groups?.[0]?.includes(\"muc\"),\n    };\n  });\n  window.presence = presence;\n  window.roster = extendedRoster;\n  window.activities = activities;\n\n  console.log('new presence list', presence);\n  console.log(\"extended roster\", extendedRoster);\n\n  // find my own user from the User API\n  const me = allUsers.find((u) => client.jid.match(u.user_id)) || {};\n\n  const reconnect = useCallback(async () => {\n    // client.config.credentials.password = user.signInUserSession.idToken.jwtToken;\n    const password = Auth.currentSession.idToken.jwtToken;\n    client.updateConfig({ ...(client.config.credentials), password });\n    console.log(\"reconnecting. password:\", password);\n    client.connect();\n  }, [client]);\n\n  const signOut = async () => {\n    db.messages.clear();\n    client.disconnect();\n    setConnected(false);\n    setRoster([]);\n    setPresence({});\n    localStorage.removeItem(\"visionable-xmpp-hostname\"); // grab this from context\n    signOutAWS();\n  };\n\n  const acceptInvite = (message) => {\n    setInviteResponses((prev) => ({ ...prev, [message.id]: \"accept\" }))\n    client.sendMessage({ to: message.from, body: message.id, type: 'meeting-invite-accept' });\n  };\n\n  const rejectInvite = (message) => {\n    setInviteResponses((prev) => ({ ...prev, [message.id]: \"reject\" }))\n    client.sendMessage({ to: message.from, body: message.id, type: 'meeting-invite-reject' });\n  };\n\n  /*\n  const changeName = () => {\n    client.publishVCard({ fullName: newName });\n  };\n\n  const getVCard = async () => {\n    try {\n      const card = await client.getVCard(jid);\n      console.log(\"my card\", card);\n      setNewName(card?.fullName);\n    } catch (e) {\n      console.error(\"Error getting vcard\", e);\n    }\n  };\n\n  const getMUCLightRooms = async () => {\n    const res = await client.getDiscoItems(MUC_LIGHT_HOSTNAME);\n  }\n*/\n\n  if (!client) {\n    return (\n      <div className=\"App\">Loading</div>\n    );\n  }\n\n  return (\n    <div className=\"App\">\n      <SideBar nav={nav} setNav={setNav} signOut={signOut} client={client} me={me} hostname={hostname} />\n\n      <Snackbar\n        onClick={reconnect}\n        open={!connected}\n        anchorOrigin={{ horizontal: \"center\", vertical: \"bottom\" }}\n        sx={{ cursor: \"pointer\" }}\n      >\n        <Alert severity=\"error\" sx={{ width: '100%' }}>Disconnected. Click here to reconnect</Alert>\n      </Snackbar>\n\n      <IncomingInvites\n        accept={acceptInvite}\n        reject={rejectInvite}\n        invites={incomingInvites}\n        responses={inviteResponses} />\n\n      <Box className=\"main\">\n        {nav === 'contacts'\n          ? <Roster\n            roster={extendedRoster}\n            // presence={presence}\n            allUsers={allUsers}\n            client={client}\n            API_BASE={apiBase}\n            MUC_LIGHT_HOSTNAME={mucHostname}\n            jwt={jwt}\n            />\n          : nav === 'messages'\n            ? <Messages\n              roster={extendedRoster}\n              // presence={presence}\n              allUsers={allUsers}\n              client={client}\n              API_BASE={apiBase}\n              MUC_LIGHT_HOSTNAME={mucHostname}\n              jwt={jwt}\n              />\n            : null}\n      </Box>\n    </div>\n  );\n};\n\nconst IncomingInvites = ({ accept, reject, invites, responses }) =>\n  invites.filter((m) => !responses[m.id]).map((m) => (\n    <Dialog key={m.id} open={true}>\n      <DialogTitle>Meeting Invite</DialogTitle>\n      <DialogContent>\n        <p>Invite ID: {m.id}</p>\n        <p>From: {m.from}</p>\n        <p>Meeting ID: {m.body}</p>\n      </DialogContent>\n      <DialogActions>\n        <Button color=\"error\" onClick={() => reject(m)}>Reject</Button>\n        <Button onClick={() => accept(m)}>Accept</Button>\n      </DialogActions>\n    </Dialog>\n  ));\n\nconst getAllUsers = async (jwt, apiBase) => {\n  const res = await fetch(`${apiBase}/api/user`, { headers: { Authorization: jwt } });\n  return res.ok ? res.json() : [];\n}\n\nfunction userFullName(user) {\n  return user?.name\n  ? user.name\n    : user?.user_displayname\n      ? user.user_displayname\n      : user?.user_firstname\n        ? `${user.user_firstname} ${user.user_lastname}`\n        : \"[No Name]\";\n}\n\nasync function getAllMessages({ client, start, after }) {\n  const paging = after ? { after } : {};\n  const { complete, paging: { last } } = await client.searchHistory({ start, paging });\n\n  if (!complete) {\n    getAllMessages({ client, after: last });\n  }\n}\n\nexport default App;\n","import React, { useState, useEffect, createContext } from 'react';\nimport ReactDOM from 'react-dom';\nimport App from './App';\nimport CssBaseline from '@mui/material/CssBaseline';\n\nimport Amplify from \"aws-amplify\";\nimport { Authenticator } from '@aws-amplify/ui-react';\nimport '@aws-amplify/ui-react/styles.css';\n\nconst Context = createContext({});\n\nconst HOSTNAME_KEY = \"visionable-xmpp-hostname\";\nconst lastHostname = localStorage.getItem(HOSTNAME_KEY);\nconst hostname = lastHostname || prompt(\"Enter hostname\", \"saas.visionable.one\");\nlocalStorage.setItem(HOSTNAME_KEY, hostname);\n\nconst AppContainer = () => {\n  const [config, setConfig] = useState(null);\n\n  const configure = async () => {\n    const json = await getServiceConfig(hostname)\n\n    Amplify.configure({\n      Auth: {\n        region: json['aws-region'],\n        userPoolId: json['aws-user-pool-id'],\n        userPoolWebClientId: json['aws-user-pool-client-id'],\n      },\n    });\n\n    setConfig(json);\n  };\n\n  useEffect(() => configure(), []);\n\n  const value = {\n    HOSTNAME_KEY\n  };\n\n  return !config\n    ? null\n    : (\n      <Context.Provider value={value}>\n        <Authenticator\n          components={{\n            Header() {\n              return (\n                <div style={{ textAlign: \"center\", marginBottom: \"2em\" }}>\n                  <img\n                    alt=\"Visionable logo\"\n                    style={{ maxWidth: \"300px\" }}\n                    src=\"https://v3.visionable.io/images/visionable-logo.svg\" />\n                </div>\n              );\n            }\n          }}\n          signUpAttributes={[\n            'family_name',\n            'given_name',\n            'updated_at',\n          ]}\n          loginMechanisms={['email']}\n        >\n          {({ signOut, user }) => (\n            <App signOutAWS={signOut} user={user} hostname={hostname} />\n          )}\n        </Authenticator>\n      </Context.Provider>\n    );\n};\n\nReactDOM.render(\n  <React.StrictMode>\n    <CssBaseline />\n    <AppContainer />\n  </React.StrictMode>,\n  document.getElementById('root')\n);\n\nasync function getServiceConfig(hostname) {\n  try {\n    const res = await fetch(`https://${hostname}/config.json`, { mode: \"cors\" });\n    return await res.json();\n  } catch(e) {\n    console.log(e);\n    alert(\"Error requesting configuration data for this service\");\n    localStorage.removeItem(HOSTNAME_KEY);\n    window.location.reload();\n  }\n}\n"],"sourceRoot":""}